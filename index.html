<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard SDR</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
      body { background-color: #f8f9fc; }
    </style>
  </head>
  <body>
    <section class="section">
      <div class="container">
        <div class="level">
          <div class="level-left">
            <h1 class="title">ðŸ“Š Dashboard SDR</h1>
          </div>
        </div>

        <!-- MÃ©tricas -->
        <div class="columns is-multiline" id="metricas">
          <!-- Cards inseridos via JS -->
        </div>

        <!-- GrÃ¡ficos -->
        <div id="chartsContainer" class="columns is-multiline">
          <!-- GrÃ¡ficos inseridos via JS -->
        </div>
      </div>
    </section>

    <script type="module">
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

      const supabase = createClient(
        'https://eunburxiqtzftppqvxtr.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1bmJ1cnhpcXR6ZnRwcHF2eHRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjU1Njc3MzEsImV4cCI6MjA0MTE0MzczMX0.y-EgwTJ-uEzbLa_bTSzbEN10dSyTVrSJ27zrl51MLKc'
      );

      async function fetchData() {
        const { data, error } = await supabase
          .from('dashboard_sdr')
          .select('selected_options, cursos, result, student, th, utm_status');

        if (error) {
          console.error('Erro ao buscar dados:', error);
          return;
        }

        const campos = {
          result: {},
          student: {},
          cursos: {},
          selected_options: {},
          th: {},
          utm_status: {},
        };

        data.forEach(row => {
          for (const key in campos) {
            const valor = row[key];
            if (Array.isArray(valor)) {
              valor.forEach(v => {
                if (!campos[key][v]) campos[key][v] = 0;
                campos[key][v]++;
              });
            } else if (valor && typeof valor === 'object') {
              Object.entries(valor).forEach(([subKey, subVal]) => {
                const label = `${subKey}: ${subVal}`;
                if (!campos[key][label]) campos[key][label] = 0;
                campos[key][label]++;
              });
            } else {
              const normalizado = String(valor ?? 'Vazio');
              if (!campos[key][normalizado]) campos[key][normalizado] = 0;
              campos[key][normalizado]++;
            }
          }
        });

        renderMetricCards(campos);
        renderCharts(campos);
      }

      function renderMetricCards(campos) {
        const metricas = document.getElementById('metricas');
        metricas.innerHTML = '';

        for (const campo in campos) {
          const dados = campos[campo];
          const total = Object.values(dados).reduce((a, b) => a + b, 0);

          const card = document.createElement('div');
          card.className = 'column is-one-fifth';
          card.innerHTML = `
            <div class="box has-text-centered">
              <p class="title is-5">${campo}</p>
              <p class="title is-3">${total}</p>
            </div>
          `;
          metricas.appendChild(card);
        }
      }

      function renderCharts(campos) {
        const container = document.getElementById('chartsContainer');
        container.innerHTML = '';

        for (const campo in campos) {
          const dados = campos[campo];
          if (Object.keys(dados).length === 0) continue;

          const chartBox = document.createElement('div');
          chartBox.className = Object.keys(dados).length > 5 ? 'column is-full' : 'column is-half';
          chartBox.innerHTML = `
            <div class="box">
              <p class="title is-5">${campo}</p>
              <canvas id="chart-${campo}"></canvas>
            </div>
          `;
          container.appendChild(chartBox);

          const ctx = chartBox.querySelector('canvas').getContext('2d');

          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: Object.keys(dados),
              datasets: [{
                label: campo,
                data: Object.values(dados),
                backgroundColor: '#36A2EB'
              }]
            },
            options: {
              plugins: {
                legend: { display: true },
                datalabels: {
                  color: '#000',
                  anchor: 'center',
                  align: 'center',
                  font: { weight: 'bold' },
                  formatter: (value) => value
                }
              },
              responsive: true,
              scales: {
                y: { beginAtZero: true }
              }
            },
            plugins: [ChartDataLabels]
          });
        }
      }

      fetchData();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard SDR</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
      body { background-color: #f8f9fc; }
      .sidebar {
        height: 100vh;
        width: 250px;
        position: fixed;
        top: 0;
        right: -250px;
        background-color: #fff;
        box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
        padding: 1rem;
        overflow-y: auto;
        z-index: 100;
        transition: right 0.3s ease;
      }
      .sidebar.is-active {
        right: 0;
      }
      .main-content {
        padding: 1rem;
        transition: margin-right 0.3s ease;
      }
      .toggle-sidebar {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 101;
      }
    </style>
  </head>
  <body>
    <button class="button is-primary toggle-sidebar" id="openSidebarBtn" onclick="toggleSidebar()">â˜° Filtros</button>

    <aside class="sidebar" id="sidebar">
      <h2 class="title is-5">Filtrar GrÃ¡ficos</h2>
      <div class="field">
        <label class="label">Pergunta</label>
        <div class="control">
          <div class="select is-fullwidth">
            <select id="campoSelect">
              <option value="todos">Todos</option>
            </select>
          </div>
        </div>
      </div>
      <button class="button is-danger is-fullwidth mt-4" onclick="toggleSidebar()">Fechar</button>
    </aside>

    <section class="section main-content" id="mainContent">
      <div class="container">
        <div class="level">
          <div class="level-left">
            <h1 class="title">ðŸ“Š Dashboard SDR</h1>
          </div>
        </div>

        <div id="chartsContainer" class="columns is-multiline"></div>
      </div>
    </section>

    <script type="module">
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

      const supabase = createClient(
        'https://eunburxiqtzftppqvxtr.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV1bmJ1cnhpcXR6ZnRwcHF2eHRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjU1Njc3MzEsImV4cCI6MjA0MTE0MzczMX0.y-EgwTJ-uEzbLa_bTSzbEN10dSyTVrSJ27zrl51MLKc'
      );

      let selectedQuestions = {};

      async function fetchData() {
        const { data, error } = await supabase
          .from('dashboard_sdr')
          .select('selected_options, student, cursos, th, utm_status');

        if (error) {
          console.error('Erro ao buscar dados:', error);
          return;
        }

        let camposExtras = {
          student: {},
          cursos: {},
          th: {},
          utm_status: {}
        };

        data.forEach(row => {
          let options = row.selected_options;

          try {
            if (typeof options === 'string') {
              const fixed = options
                .replace(/([\{,\s])(\w+)(?=\s*:)/g, '$1"$2"')
                .replace(/: (\w+)([\s,\}])/g, ': "$1"$2');
              options = JSON.parse(fixed);
            }

            if (options && Array.isArray(options.selectedOptions)) {
              options.selectedOptions.forEach(value => {
                const question = 'Motivo de Interesse';
                const answer = value;
                if (!selectedQuestions[question]) selectedQuestions[question] = {};
                if (!selectedQuestions[question][answer]) selectedQuestions[question][answer] = 0;
                selectedQuestions[question][answer]++;
              });
            }
          } catch (e) {
            console.warn('Erro ao processar selected_options:', e);
          }

          for (const campo in camposExtras) {
            const valor = row[campo];
            const normalizado = String(valor ?? 'Vazio');
            if (!camposExtras[campo][normalizado]) camposExtras[campo][normalizado] = 0;
            camposExtras[campo][normalizado]++;
          }
        });

        selectedQuestions = { ...selectedQuestions, ...camposExtras };

        renderCharts(selectedQuestions);
        populateSelect(Object.keys(selectedQuestions));
      }

      function populateSelect(questions) {
        const select = document.getElementById('campoSelect');
        questions.forEach(question => {
          const option = document.createElement('option');
          option.value = question;
          option.textContent = question;
          select.appendChild(option);
        });
      }

      function renderCharts(dataset) {
        const container = document.getElementById('chartsContainer');
        container.innerHTML = '';

        for (const question in dataset) {
          const data = dataset[question];

          const chartBox = document.createElement('div');
          chartBox.className = 'column is-full';
          chartBox.innerHTML = `
            <div class="box">
              <p class="title is-5">${question}</p>
              <canvas id="chart-${question}"></canvas>
            </div>
          `;
          container.appendChild(chartBox);

          const ctx = chartBox.querySelector('canvas').getContext('2d');

          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: Object.keys(data),
              datasets: [{
                label: question,
                data: Object.values(data),
                backgroundColor: '#36A2EB'
              }]
            },
            options: {
              plugins: {
                legend: { display: false },
                datalabels: {
                  color: '#000',
                  anchor: 'center',
                  align: 'center',
                  font: { weight: 'bold' },
                  formatter: (value) => value
                }
              },
              responsive: true,
              scales: {
                y: { beginAtZero: true }
              }
            },
            plugins: [ChartDataLabels]
          });
        }
      }

      document.getElementById('campoSelect').addEventListener('change', function () {
        const value = this.value;
        if (value === 'todos') {
          renderCharts(selectedQuestions);
        } else {
          renderCharts({ [value]: selectedQuestions[value] });
        }
      });

      window.toggleSidebar = function () {
        const sidebar = document.getElementById('sidebar');
        const btn = document.getElementById('openSidebarBtn');
        sidebar.classList.toggle('is-active');
        btn.style.display = sidebar.classList.contains('is-active') ? 'none' : 'block';
      }

      fetchData();
    </script>
  </body>
</html>
